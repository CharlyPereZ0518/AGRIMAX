<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGRIMAX - Confirmación de Pedido</title>
    <link rel="stylesheet" href="/static/css/footer.css">
    <link rel="stylesheet" href="/static/css/boton_hamburguesaP.css">
    <link rel="stylesheet" href="/static/css/pedido.css">
    <link rel="stylesheet" href="/static/css/forma_pago.css">
    <link rel="stylesheet" href="/static/css/confirmacion_pedidos.css">
    <link rel="stylesheet" href="/static/css/confirmacion_pedidos_mejorado.css">
    <script src="/static/js/boton_hamburguesaP.js" defer></script>
    <script src="/static/js/pedido.js" defer></script>
    <script src="/static/js/forma_pago.js" defer></script>
    <script src="/static/js/confirmacion_pedidos.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/contraste.css">
    <script src="/static/js/accesibilidad.js" defer></script>
    <script src="/static/js/accesibilidad_global.js"></script>
</head>
<body class="{{ 'cursor-large' if usuario.cursor_size == 'large' else '' }} 
              {{ 'modo-lector' if usuario.modo_lector == 'on' else '' }} 
              {{ usuario.nivel_contraste if usuario.nivel_contraste else '' }}
              {{ 'font-large' if usuario.font_size == 'large' else 'font-x-large' if usuario.font_size == 'x-large' else '' }}
              {{ 'modo-oscuro' if usuario.modo_oscuro == 'on' else '' }}
              {{ 'modo-grises' if usuario.modo_grises == 'on' else '' }}"
     data-contraste="{{ usuario.nivel_contraste }}"
     style="{{ 'font-family: ' + usuario.font_family + ';' if usuario.font_family else '' }}">
     
    {% if not session.get('usuario_id') %}
    <script>
        window.location.href = "{{ url_for('login') }}";
    </script>
    {% endif %}

    <header class="header">
        <div class="logo" onclick="location.href='/menu_principal'">AGRIMAX</div>
        <button id="menuBtn" class="menu-btn">☰</button>
        <div class="header-right">
            <button class="cart-btn" onclick="location.href='{{ url_for('carrito.carrito') }}'">
                <i class="fas fa-shopping-cart"></i>
            </button>
        </div>

        <div id="mensajeCompra" class="mensaje-flotante">
            ¡Compra exitosa! Se ha enviado un correo de confirmación.
        </div>
    </header>

    <div id="sidebar" class="sidebar">
        <ul class="sidebar-menu">
            <li><a href="{{ url_for('usuarios.perfil', usuario_id=session['usuario_id']) }}">PERFIL</a></li>
            <li><a href="{{ url_for('menu_clientes.menu_principal') }}">MENÚ PRINCIPAL</a></li>
            <li>
                <button class="dropdown-btn">CATEGORÍAS <i class="fas fa-caret-down"></i></button>
                <ul class="dropdown-container">
                    <li><a href="{{ url_for('verduras.verduras') }}">Verduras</a></li>
                    <li><a href="{{ url_for('frutas.frutas') }}">Frutas</a></li>
                    <li><a href="{{ url_for('legumbres.legumbres') }}">Granos</a></li>
                    <li><a href="{{ url_for('hortalizas.hortalizas') }}">Hortalizas</a></li>
                </ul>
            </li>
            <li><a href="{{ url_for('configuracion.configuracion') }}">CONFIGURACIÓN</a></li>
            <li><a href="{{ url_for('logout.logout') }}" class="logout-btn">CERRAR SESIÓN</a></li>
        </ul>
    </div>

    <div id="overlay" class="overlay"></div>

    <!-- Indicador de pasos -->
    <div class="pasos-proceso">
        <div class="paso activo">
            <div class="numero-paso">1</div>
            <span>Pedido</span>
        </div>
        <div class="paso">
            <div class="numero-paso">2</div>
            <span>Pago</span>
        </div>
        <div class="paso">
            <div class="numero-paso">3</div>
            <span>Confirmación</span>
        </div>
    </div>

    <!-- Sección de Pedido -->
    <section id="pedido-section" class="order-container">
        <h1 class="order-title">CONFIRMAR PEDIDO</h1>
        
        <!-- Resumen del carrito -->
        <!-- Resumen del carrito -->
<div class="resumen-pedido">
    <h3><i class="fas fa-shopping-basket"></i> Resumen de tu Pedido</h3>
    <div id="resumen-productos">
        {% for producto in productos %}
        <div class="producto-resumen">
            <span>{{ producto.nombre }} x{{ producto.cantidad }}</span>
            <span>${{ "%.2f"|format(producto.subtotal) }}</span>
        </div>
        {% endfor %}
    </div>
    <div class="total-resumen">
        Total: $<span id="total-pedido">{{ "%.2f"|format(total) }}</span>
    </div>
</div>

        <h2 class="section-title">Detalles del Pedido</h2>
        
        <div class="form-group">
            <label><i class="fas fa-box"></i> Tipo de Empaque</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="package" value="costal" checked> 
                    <i class="fas fa-weight-hanging"></i> Costal
                </label>
                <label class="radio-option">
                    <input type="radio" name="package" value="bolsa"> 
                    <i class="fas fa-shopping-bag"></i> Bolsa
                </label>
                <label class="radio-option">
                    <input type="radio" name="package" value="caja"> 
                    <i class="fas fa-box-open"></i> Caja
                </label>
            </div>
        </div>

        <!-- Nuevo: Tipo de entrega -->
        <div class="form-group">
            <label><i class="fas fa-truck"></i> Método de Entrega</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="delivery-method" value="domicilio" checked> 
                    <i class="fas fa-home"></i> Entrega a Domicilio
                </label>
                
            </div>
        </div>
        
        <div class="button-group">
            <button type="button" class="btn btn-next" onclick="siguientePaso('forma-pago-section', 2)">
                <i class="fas fa-arrow-right"></i> SIGUIENTE
            </button>
        </div>
    </section>

    <!-- Sección de Forma de Pago -->
    <section id="forma-pago-section" class="payment-container" style="display: none;">
        <h1 class="payment-title">INFORMACIÓN DE PAGO</h1>
        
        <!-- Información de contacto -->
        <div class="form-group">
            <label for="contact-phone"><i class="fas fa-phone"></i> Teléfono de Contacto</label>
            <input type="tel" id="contact-phone" class="form-control" placeholder="+52 123 456 7890" required>
        </div>

        <div class="form-group">
            <label for="contact-email"><i class="fas fa-envelope"></i> Correo Electrónico</label>
            <input type="email" id="contact-email" class="form-control" placeholder="tu@email.com" required>
        </div>
        
        <h2 class="section-title"><i class="fas fa-credit-card"></i> Forma de Pago</h2>
        
        <div class="form-group">
            <label>Seleccione método de pago</label>
            <div class="radio-group vertical">
                
                <label class="radio-option large">
                    <input type="radio" name="payment-method" value="tarjeta"> 
                    <i class="fas fa-credit-card"></i> Tarjeta de Crédito/Débito
                    <small>Pago seguro con MercadoPago</small>
                </label>
               
            </div>
        </div>

        <div class="form-group">
            <label><i class="fas fa-file-invoice"></i> ¿Necesita factura?</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="invoice" value="si"> SÍ
                </label>
                <label class="radio-option">
                    <input type="radio" name="invoice" value="no" checked> NO
                </label>
            </div>
        </div>

        <!-- Información de facturación (se muestra solo si selecciona SÍ) -->
        <div id="datos-facturacion" style="display: none;">
            <h3 class="section-title"><i class="fas fa-file-alt"></i> Datos de Facturación</h3>
            <div class="form-group">
                <label for="rfc">RFC</label>
                <input type="text" id="rfc" class="form-control" placeholder="ABCD123456XYZ">
            </div>
            <div class="form-group">
                <label for="razon-social">Razón Social</label>
                <input type="text" id="razon-social" class="form-control" placeholder="Empresa S.A. de C.V.">
            </div>
            <div class="form-group">
                <label for="direccion-fiscal">Dirección Fiscal</label>
                <textarea id="direccion-fiscal" class="form-control" rows="3" placeholder="Calle, Número, Colonia, CP, Ciudad..."></textarea>
            </div>
        </div>

        <h3 class="section-title"><i class="fas fa-shipping-fast"></i> Dirección de Entrega</h3>
        <div class="form-group">
            <label for="direccion-entrega">Dirección de Entrega *</label>
            <textarea id="direccion-entrega" class="form-control" rows="3" placeholder="Calle, Número, Colonia, CP, Ciudad, Estado..." required></textarea>
        </div>
        <div class="form-group">
            <label for="referencias-entrega">Referencias Adicionales</label>
            <textarea id="referencias-entrega" class="form-control" rows="2" placeholder="Entre calles, puntos de referencia, indicaciones especiales..."></textarea>
        </div>
        
        <div class="button-group">
            <button type="button" class="btn btn-previous" onclick="anteriorPaso('pedido-section', 1)">
                <i class="fas fa-arrow-left"></i> ANTERIOR
            </button>
            <button type="button" class="btn btn-next" onclick="siguientePaso('confirmacion-section', 3)">
                <i class="fas fa-arrow-right"></i> SIGUIENTE
            </button>
        </div>
    </section>

    <!-- Sección de Confirmación -->
   <!-- Reemplaza solo la sección de confirmación en tu HTML -->
<section id="confirmacion-section" class="confirmation-container" style="display: none;">
    <h1 class="confirmation-title"><i class="fas fa-clipboard-check"></i> CONFIRMACIÓN FINAL</h1>
    
    <!-- Tarjeta de resumen elegante -->
    <div class="confirmacion-card">
        <div class="confirmacion-header">
            <i class="fas fa-check-circle"></i>
            <h2>¡Estás a un paso de completar tu pedido!</h2>
            <p>Revisa que toda la información sea correcta</p>
        </div>
        
        <div class="confirmacion-body">
            <!-- Información del pedido -->
            <div class="info-group">
                <h3><i class="fas fa-shopping-basket"></i> Resumen del Pedido</h3>
                <div class="info-grid">
                    <div class="info-item">
    <span class="info-label">Total de productos:</span>
    <span class="info-value" id="cantidad-total">{{ productos|length }} producto{% if productos|length != 1 %}s{% endif %}</span>
</div>
<div class="info-item">
    <span class="info-label">Monto total:</span>
    <span class="info-value precio-total">${{ "%.2f"|format(total) }} MXN</span>
</div>
                    <div class="info-item">
                        <span class="info-label">Tipo de empaque:</span>
                        <span class="info-value" id="tipo-empaque">Costal</span>
                    </div>
                </div>
            </div>

            <!-- Información de entrega -->
            <div class="info-group">
                <h3><i class="fas fa-truck"></i> Información de Entrega</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Método:</span>
                        <span class="info-value" id="metodo-entrega">Entrega a domicilio</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Contacto:</span>
                        <span class="info-value" id="contacto-info">+52 123 456 7890</span>
                    </div>
                </div>
            </div>

            <!-- Información de pago -->
            <div class="info-group">
                <h3><i class="fas fa-credit-card"></i> Información de Pago</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Método de pago:</span>
                        <span class="info-value" id="metodo-pago">Transferencia bancaria</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Factura:</span>
                        <span class="info-value" id="factura-info">No</span>
                    </div>
                </div>
            </div>

            <!-- Lista de productos -->
            <!-- Lista de productos -->
<div class="info-group">
    <h3><i class="fas fa-list-ol"></i> Productos en tu pedido</h3>
    <div class="productos-lista" id="lista-productos-final">
        {% for producto in productos %}
        <div class="producto-item-final">
            <div class="producto-nombre">{{ producto.nombre }}</div>
            <div class="producto-detalles">
                <span>Cantidad: {{ producto.cantidad }}</span>
                <span>Precio: ${{ "%.2f"|format(producto.precio) }}</span>
                <span class="producto-precio">Subtotal: ${{ "%.2f"|format(producto.subtotal) }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

        <div class="confirmacion-footer">
    <div class="total-final">
        <span class="total-label">TOTAL A PAGAR:</span>
        <span class="total-amount">${{ "%.2f"|format(total) }} MXN</span>
    </div>
</div>

    <!-- Opciones de confirmación -->
    <div class="opciones-confirmacion">
        <div class="form-group">
            <label><i class="fas fa-bell"></i> Notificación de confirmación</label>
            <div class="radio-group-horizontal">
                <label class="radio-option">
                    <input type="radio" name="confirmation" value="notificacion" checked> 
                    <i class="fas fa-mobile-alt"></i> Solo notificación
                </label>
                <label class="radio-option">
                    <input type="radio" name="confirmation" value="correo"> 
                    <i class="fas fa-envelope"></i> Solo correo
                </label>
                <label class="radio-option">
                    <input type="radio" name="confirmation" value="ambos"> 
                    <i class="fas fa-comments"></i> Ambos
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="comentarios-final"><i class="fas fa-edit"></i> Comentarios adicionales (opcional)</label>
            <textarea id="comentarios-final" class="form-control" rows="3" 
                     placeholder="Instrucciones especiales para la entrega, comentarios sobre el pedido..."></textarea>
        </div>
    </div>

    <!-- Términos y condiciones -->
    <div class="terminos-final">
        <div class="checkbox-option grande">
            <input type="checkbox" id="acepto-terminos-final" required>
            <div class="checkbox-content">
                <span class="checkbox-text">
                    He revisado y acepto los 
                    <a href="#" class="link-destacado">términos y condiciones</a> 
                    y las 
                    <a href="#" class="link-destacado">políticas de privacidad</a> 
                    de AGRIMAX. Confirmo que toda la información proporcionada es correcta.
                </span>
            </div>
        </div>
    </div>
    
    <!-- Botones de acción -->
    <div class="acciones-final">
        <button type="button" class="btn btn-secundario" onclick="anteriorPaso('forma-pago-section', 2)">
            <i class="fas fa-arrow-left"></i> VOLVER A PAGO
        </button>
        
        <form id="form-mercadopago" method="POST" action="{{ url_for('mercadopago.mercadopago_pago') }}" style="display:inline;">
            <input type="hidden" name="carrito_json" id="carrito_json">
            <input type="hidden" name="datos_pedido" id="datos_pedido">
            <button type="button" class="btn btn-principal" onclick="procesarPedido()" id="btn-procesar-pedido" disabled>
                <i class="fas fa-lock"></i> CONFIRMAR Y PAGAR
            </button>
        </form>
    </div>
</section>
<script>
    // Funciones de navegación entre pasos
    function siguientePaso(seccionId, pasoNumero) {
        document.querySelectorAll('section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(seccionId).style.display = 'block';
        actualizarPasos(pasoNumero);
    }

    function anteriorPaso(seccionId, pasoNumero) {
        document.querySelectorAll('section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(seccionId).style.display = 'block';
        actualizarPasos(pasoNumero);
    }

    function actualizarPasos(pasoActual) {
        document.querySelectorAll('.paso').forEach((paso, index) => {
            paso.classList.remove('activo', 'completado');
            if (index + 1 < pasoActual) {
                paso.classList.add('completado');
            } else if (index + 1 === pasoActual) {
                paso.classList.add('activo');
            }
        });
    }

    // Mostrar/ocultar datos de facturación
    document.querySelectorAll('input[name="invoice"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('datos-facturacion').style.display = 
                this.value === 'si' ? 'block' : 'none';
        });
    });

    // Habilitar botón de pago cuando se acepten términos
    document.getElementById('acepto-terminos-final').addEventListener('change', function() {
        document.getElementById('btn-procesar-pedido').disabled = !this.checked;
    });

    // Cargar datos reales desde el servidor (ya vienen en el template)
    function cargarDatosRealesConfirmacion() {
        // Los datos ya están cargados desde el servidor en el template
        // Solo actualizamos la información de los formularios
        const empaqueSeleccionado = document.querySelector('input[name="package"]:checked');
        if (empaqueSeleccionado) {
            let textoEmpaque = '';
            switch(empaqueSeleccionado.value) {
                case 'costal': textoEmpaque = 'Costal'; break;
                case 'bolsa': textoEmpaque = 'Bolsa'; break;
                case 'caja': textoEmpaque = 'Caja'; break;
                default: textoEmpaque = 'Costal';
            }
            document.getElementById('tipo-empaque').textContent = textoEmpaque;
        }

        const entregaSeleccionada = document.querySelector('input[name="delivery-method"]:checked');
        if (entregaSeleccionada) {
            document.getElementById('metodo-entrega').textContent = 
                entregaSeleccionada.value === 'domicilio' ? 'Entrega a domicilio' : 'Recoger en tienda';
        }

        const telefono = document.getElementById('contact-phone').value;
        const email = document.getElementById('contact-email').value;
        document.getElementById('contacto-info').textContent = telefono || email || 'No proporcionado';

        const pagoSeleccionado = document.querySelector('input[name="payment-method"]:checked');
        if (pagoSeleccionado) {
            let textoPago = '';
            switch(pagoSeleccionado.value) {
                case 'transferencia': textoPago = 'Transferencia bancaria'; break;
                case 'tarjeta': textoPago = 'Tarjeta de crédito/débito'; break;
                case 'efectivo': textoPago = 'Efectivo'; break;
                default: textoPago = 'Transferencia bancaria';
            }
            document.getElementById('metodo-pago').textContent = textoPago;
        }

        const facturaSeleccionada = document.querySelector('input[name="invoice"]:checked');
        document.getElementById('factura-info').textContent = facturaSeleccionada.value === 'si' ? 'Sí' : 'No';
    }

    // Modificar la función siguientePaso para incluir la carga de datos
    const originalSiguientePaso = siguientePaso;
    siguientePaso = function(seccionId, pasoNumero) {
        originalSiguientePaso(seccionId, pasoNumero);
        if (seccionId === 'confirmacion-section') {
            cargarDatosRealesConfirmacion();
        }
    }

    function procesarPedido() {
        if (!document.getElementById('acepto-terminos-final').checked) {
            alert('Debe aceptar los términos y condiciones');
            return;
        }

        // Validar campos requeridos
        const telefono = document.getElementById('contact-phone').value;
        const email = document.getElementById('contact-email').value;
        
        if (!telefono && !email) {
            alert('Por favor, proporcione al menos un método de contacto (teléfono o email)');
            return;
        }

        // Recopilar todos los datos del pedido
        const datosPedido = {
            empaque: document.querySelector('input[name="package"]:checked').value,
            metodoEntrega: document.querySelector('input[name="delivery-method"]:checked').value,
            metodoPago: document.querySelector('input[name="payment-method"]:checked').value,
            factura: document.querySelector('input[name="invoice"]:checked').value,
            confirmacion: document.querySelector('input[name="confirmation"]:checked').value,
            comentarios: document.getElementById('comentarios-final').value,
            telefono: telefono,
            email: email
        };

        // Validar y agregar dirección de entrega
        const direccionEntrega = document.getElementById('direccion-entrega').value;
        if (!direccionEntrega || direccionEntrega.trim() === '') {
            alert('Por favor, ingresa la dirección de entrega');
            return;
        }
        
        datosPedido.direccionEntrega = direccionEntrega;
        datosPedido.referenciasEntrega = document.getElementById('referencias-entrega').value;

        // Si necesita factura, agregar datos fiscales
        if (datosPedido.factura === 'si') {
            const rfc = document.getElementById('rfc').value;
            const razonSocial = document.getElementById('razon-social').value;
            
            if (!rfc || !razonSocial) {
                alert('Por favor, complete todos los datos de facturación');
                return;
            }
            
            datosPedido.datosFiscales = {
                rfc: rfc,
                razonSocial: razonSocial,
                direccionFiscal: document.getElementById('direccion-fiscal').value
            };
        }

        document.getElementById('datos_pedido').value = JSON.stringify(datosPedido);
        document.getElementById('form-mercadopago').submit();
    }

    // Tu código existente para el menú
    document.addEventListener('click', e => {
        const m = document.getElementById("menuContent");
        const b = document.querySelector(".menu-button");
        if (m && m.style.display === 'block' && !m.contains(e.target) && !b.contains(e.target)) {
            m.style.display = 'none';
        }
    });

    // Configuraciones de accesibilidad
    const contraste = localStorage.getItem('nivel_contraste') || 'normal';
    const body = document.body;
    body.classList.remove('contraste-alto', 'contraste-muy-alto', 'modo-oscuro');
    
    if (contraste !== 'normal') {
        switch (contraste) {
            case 'alto':
                body.classList.add('contraste-alto');
                break;
            case 'muy-alto':
                body.classList.add('contraste-muy-alto');
                break;
            case 'oscuro':
                body.classList.add('modo-oscuro');
                break;
        }
    }

    if (localStorage.getItem('modoGrises') === 'true') {
        body.classList.add('modo-grises');
    }

    // Prevenir envíos duplicados
    document.querySelector("form").addEventListener("submit", function(event) {
        if (this.dataset.submitted) {
            event.preventDefault();
        }
        this.dataset.submitted = true;
    });

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar la primera sección por defecto
        document.getElementById('pedido-section').style.display = 'block';
    });
</script>
    <footer>
        <p>© 2025 AGRIMAX. TODOS LOS DERECHOS RESERVADOS.</p>
    </footer>
</body>
</html>