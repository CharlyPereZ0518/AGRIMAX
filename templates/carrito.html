<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - AGRIMAX</title>
    <link rel="stylesheet" href="/static/css/boton_hamburguesaP.css">
    <link rel="stylesheet" href="/static/css/carrito.css">
    <link rel="stylesheet" href="/static/css/contraste.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/footer.css">
    <script src="/static/js/boton_hamburguesaP.js"></script>
    <script src="/static/js/accesibilidad.js" defer></script>
    <script src="/static/js/accesibilidad_global.js"></script>
    
</head>
<body class="{{ 'cursor-large' if usuario.cursor_size == 'large' else '' }} 
              {{ 'modo-lector' if usuario.modo_lector == 'on' else '' }} 
              {{ usuario.nivel_contraste if usuario.nivel_contraste else '' }}
              {{ 'font-large' if usuario.font_size == 'large' else 'font-x-large' if usuario.font_size == 'x-large' else '' }}
              {{ 'modo-oscuro' if usuario.modo_oscuro == 'on' else '' }}
              {{ 'modo-grises' if usuario.modo_grises == 'on' else '' }}"
     data-contraste="{{ usuario.nivel_contraste }}"
     style="{{ 'font-family: ' + usuario.font_family + ';' if usuario.font_family else '' }}">

{% if not session.get('usuario_id') %}
<script>
    window.location.href = "{{ url_for('login') }}";
</script>
{% endif %}

<header class="header">
    <div class="logo" onclick="location.href='/menu_principal'">AGRIMAX</div>
    <button id="menuBtn" class="menu-btn">☰</button>
    <div class="header-right">
        <button class="cart-btn" onclick="location.href='{{ url_for('carrito.carrito') }}'">
            <i class="fas fa-shopping-cart"></i>
        </button>
    </div>
</header>

<div class="sidebar" id="sidebar">
    <ul class="sidebar-menu">
        <li><a href="{{ url_for('menu_clientes.menu_principal') }}">MENÚ PRINCIPAL</a></li>
        <li>
            <button class="dropdown-btn">CATEGORÍAS <i class="fas fa-caret-down"></i></button>
            <ul class="dropdown-container">
                <li><a href="{{ url_for('verduras.verduras') }}">Verduras</a></li>
                <li><a href="{{ url_for('frutas.frutas') }}">Frutas</a></li>
                <li><a href="{{ url_for('legumbres.legumbres') }}">Granos</a></li>
                <li><a href="{{ url_for('hortalizas.hortalizas') }}">Hortalizas</a></li>
            </ul>
        </li>
        <li><a href="{{ url_for('configuracion.configuracion') }}">CONFIGURACIÓN</a></li>
        <li><a href="{{ url_for('logout.logout') }}" class="logout-btn">CERRAR SESIÓN</a></li>
    </ul>
</div>

<div id="overlay" class="overlay"></div>

<main>
    <h1>Carrito de Compras</h1>

    <div class="cart-container">
    {% if productos %}
        {% for producto in productos %}
        <div class="cart-item">
            <img src="{{ url_for('static', filename=producto.imagen) if producto.imagen else url_for('static', filename='imagenes/default-product.jpg') }}" alt="{{ producto.nombre }}">
            <div class="item-info">
                <h3>{{ producto.nombre }}</h3>
                <p>{{ producto.descripcion }}</p>
                <p><strong>Categoría:</strong> {{ producto.categoria }}</p>
                <p><strong>Precio unitario:</strong> ${{ producto.precio }}</p>
                <div class="quantity-controls">
                    <input type="number"
                         name="cantidad"
                        value="{{ producto.cantidad }}"
                        min="0"
                        class="cantidad-input"
                        data-producto-id="{{ producto.id }}"
                    >   
                </div>
                <p class="subtotal"><strong>Subtotal:</strong> ${{ producto.subtotal }}</p>
            </div>
        </div>
        {% endfor %}
        <h2 class="total-price">Total: ${{ total }}</h2>
    {% else %}
        <p class="empty-cart">Tu carrito está vacío.</p>
    {% endif %}
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    </div>

    <div class="button-group">
        <form method="POST" action="{{ url_for('vaciar_carrito.vaciar_carrito') }}">
            <button type="submit" class="btn-cancelar">
                <i class="fas fa-trash"></i> Vaciar Carrito
            </button>
        </form>
        <form method="POST" action="{{ url_for('confirmar_pedidos.confirmar_pedido') }}" onsubmit="sessionStorage.setItem('compraExitosa', true);">
            <button type="submit" class="btn-comprar" {{ 'disabled' if not productos }}>
                <i class="fas fa-shopping-bag"></i> Comprar
            </button>
        </form>
    </div>
</main>

<footer>
    <p>© 2025 AGRIMAX. TODOS LOS DERECHOS RESERVADOS.</p>
</footer>

<script>
    // Funcionalidad del carrito
    document.addEventListener('DOMContentLoaded', function() {
        // Actualizar cantidad al cambiar input
        document.querySelectorAll('.cantidad-input').forEach(input => {
            input.addEventListener('change', function() {
                actualizarCantidad(this);
            });
            
            input.addEventListener('input', function() {
                actualizarSubtotal(this);
            });
        });
    });

    function actualizarSubtotal(input) {
        const cartItem = input.closest('.cart-item');
        const precioText = cartItem.querySelector('p:nth-child(4)').textContent;
        const precio = parseFloat(precioText.replace('Precio unitario: $', ''));
        const cantidad = parseInt(input.value) || 0;
        
        const subtotal = precio * cantidad;
        const subtotalElement = cartItem.querySelector('.subtotal');
        subtotalElement.innerHTML = `<strong>Subtotal:</strong> $${subtotal.toFixed(2)}`;
        
        recalcularTotal();
    }

    function recalcularTotal() {
        let total = 0;
        document.querySelectorAll('.cart-item').forEach(item => {
            const subtotalText = item.querySelector('.subtotal').textContent;
            const subtotal = parseFloat(subtotalText.replace('Subtotal: $', ''));
            total += subtotal;
        });
        document.querySelector('.total-price').textContent = `Total: $${total.toFixed(2)}`;
    }

    function actualizarCantidad(input) {
        const productoId = input.dataset.productoId;
        const cantidad = parseInt(input.value) || 0;
        
        // Actualizar en servidor
        fetch('/actualizar_cantidad_carrito', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                producto_id: productoId,
                cantidad: cantidad
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Error actualizando cantidad:', data.error);
                // Revertir cambios en caso de error
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            location.reload();
        });
    }
</script>

</body>
</html>